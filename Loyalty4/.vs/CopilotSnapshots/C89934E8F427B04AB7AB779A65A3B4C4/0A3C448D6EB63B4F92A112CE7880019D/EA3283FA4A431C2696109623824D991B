//******************************************************************************************
//$TRAN,00001,1,1,001000195,250,1,1,19/07/07,11:22:04,2
//$PAYM,14,Loyalty,250
//$ITEM,00001,00000010,1,250
//******************************************************************************************
#include <math.h>
//******************************************************************************************
#include "..\SPosLoyalty4Shared\SQLTable_AuditPeriod\SQLRowSetAuditPeriod.h"
//******************************************************************************************
#include "..\SPosLoyalty4Shared\SQLNamespaces.h"
//******************************************************************************************
#include "..\SPosLoyalty4Shared\AuditRecord_base.h"
#include "..\SPosLoyalty4Shared\LoyaltySubs.h"
#include "..\SPosLoyalty4Shared\RedeemPoints.h"
#include "..\SPosLoyalty4Shared\SQLDefines.h"
#include "..\SPosLoyalty4Shared\SQLStampOfferBuffer.h"
#include "..\SPosLoyalty4Shared\SQLTable_DeptInfo\SQLRepositoryDeptInfo.h"
#include "..\SPosLoyalty4Shared\SQLTable_Group\SQLRepositoryGroup.h"
#include "..\SPosLoyalty4Shared\SQLTable_GroupTopupBonus\SQLRepositoryGroupTopupBonus.h"
#include "..\SPosLoyalty4Shared\SQLTable_Account\SQLRepositoryAccount.h"
#include "..\SPosLoyalty4Shared\SQLTable_PluInfo\SQLRepositoryPluInfo.h"
#include "..\SPosLoyalty4Shared\SQLTable_StaffCard\SQLRepositoryStaffCard.h"
#include "..\SPosLoyalty4Shared\SQLTable_StampOfferInfo\SQLRepositoryStampOfferInfo.h"
/************************************************************************/
#include "SQLStaffAccountBuffer.h"
/************************************************************************/
#include "EposLoyaltyFile.h"
/************************************************************************/

/**********************************************************************/
// logfilepath = "c:\xloylog\LOYnnn.$$1"	( renamed from .LOG )

CEposLoyaltyFile::CEposLoyaltyFile(const char* szRenamedLogFile, CServerDataFolderSetIndex& FolderSetIndex)
{
	m_strFilename = szRenamedLogFile;
	m_pExternalLogData = NULL;
	m_bExternalMode = FALSE;
	m_nExternalCCNo = 0;
	m_FolderSetIndex = FolderSetIndex;
	Init();
}

/**********************************************************************/

CEposLoyaltyFile::CEposLoyaltyFile(CStringArray* pExternalLogData) 
{
	m_strFilename = "";
	m_pExternalLogData = pExternalLogData;
	m_bExternalMode = TRUE;
	m_nExternalCCNo = 0;
	m_FolderSetIndex.m_nDbNo = 0;
	m_FolderSetIndex.m_nSetNo = 0;
	Init();
}

/**********************************************************************/

void CEposLoyaltyFile::Init()
{
	m_strCustomerCardNo = "";
	m_strEposCardNo = "";						//exact card\Mifare number sent from epos ( inc prefix/checkdigit etc if in use )
	m_bValidData = FALSE;
	m_strError = "";
	m_bMultipleTransactions = FALSE;

	m_nTransactionAppNo = APPNO_SALE;				// assume its a sale , can be a refund
	m_nTransactionCCNo = 0;

	m_nTillNo = 0;
	m_nServerNo = 0;
	m_strTransactionNo = "";
	m_dCashSpend = 0.0;						// cash portion of total spend
	m_dCardSpend = 0.00;						// card spend ( could be Purse1 &/or Purse2 )
	m_dPurse1Spend = 0.0;						// purse1 portion of total spend
	m_dPurse2Spend = 0.0;						// purse2 portion of total spend
	m_dTotalDiscount = 0.0;

	for (int p = 0; p <= 2; p++)
	{
		for (int n = 0; n <= REVALUE_PLUNO_PERPURSE_COUNT; n++)
		{
			m_dAddToCardValue[p][n] = 0.0;
		}
	}

	for (int n = 1; n <= RENEW_PLUNO_COUNT; n++)
	{
		m_nRenewCount[n] = 0;
	}

	m_dateTransaction.SetDate("");
	m_timeTransaction.SetTime("");
	m_nTransactionPoints = 0;
	m_nPluPoints = 0;
	m_bAllowPluOrDeptBonus = TRUE;			// see if plu points are not to be recorded
	m_nPointsAwarded = 0;					// gets printed on epos receipt
	m_dBonusCash = 0;						// gets printed in epos receipt
	m_dGeneralBonusExcludedSpend = 0.0;

	for (int p = 0; p <= 2; p++)
	{
		for (int n = 0; n <= REVALUE_PLUNO_PERPURSE_COUNT; n++)
		{
			m_RevaluationInfo[p][n].m_strPluNo = "";
			m_RevaluationInfo[p][n].m_dTrip = 0.0;
			m_RevaluationInfo[p][n].m_nType = 0;
			m_RevaluationInfo[p][n].m_nPoints = 0;
			m_RevaluationInfo[p][n].m_nPercent = 0;
			m_RevaluationInfo[p][n].m_dValue = 0.0;
		}
	}

	m_dRewardTrip = 0.0;
	m_nRewardType = 0;
	m_nRewardPoints = 0;
	m_dRewardValue = 0;
	m_dRewardMultiplierTrigger = 0;
	m_bRewardIncludePurse1Spend = FALSE;
	m_bRewardIncludePurse2Spend = FALSE;
	m_bRewardIncludeCashSpend = FALSE;
	m_dRewardUpperSpendLimit = 0;
	m_bHaveRewardUpperSpendLimit = FALSE;
	m_bGotItemLine = FALSE;

	m_nStaffGiftServerNo = 0;
	SQLStaffAccountBuffer.Reset();
	SQLStampOfferBuffer.Reset();

	m_StampOfferCache.Reset();
}

/**********************************************************************/

bool CEposLoyaltyFile::ScanLogFile()
{
	m_bGotItemLine = FALSE;

	CSSFile file;
	if ( file.Open ( m_strFilename, "rb" ) == FALSE )
	{
		m_strError.Format ( "Cannot open file %s", 
			(const char*) m_strFilename );

		return FALSE;
	}

	CServerWrapper::UpdatePluInfo(m_FolderSetIndex.m_nDbNo);
	CServerWrapper::UpdateDeptInfo(m_FolderSetIndex.m_nDbNo);
	CServerWrapper::UpdateStampOfferInfo();
	CServerWrapper::UpdateLoyaltySchemeInfo();
	
	int nLineCount = 0;

	CStringArray arrayLogSave;

	CCSV csvLine;
	CString strLabel;
	while ( file.Read ( csvLine ) == TRUE )
	{
		csvLine.Get ( 0, strLabel );					// get record type

		if ( strLabel == "$TRAN" )
		{
			if ( nLineCount != 0 )						// 2nd trans line found
			{
				m_bMultipleTransactions = TRUE;
				break;
			}

			if (ProcessTranLine(&csvLine) == FALSE)	// see if valid trans line
			{
				break;
			}
		}
		else if (strLabel == "$PAYM")
		{
			ProcessPaymLine(&csvLine);
		}
		else if (strLabel == "$ITEM")
		{
			ProcessItemLine(&csvLine);
		}
		else if ((strLabel == "$LDISC") || (strLabel == "$SDISC"))
		{
			ProcessSubtotalDiscountLine(&csvLine);
		}
		else if (strLabel == "$IDISC")
		{
			ProcessItemDiscountLine(&csvLine);
		}
		else if (strLabel == "$SO_AWARD")
		{
			ProcessOfferStampAwardLine(&csvLine);
		}
		else if (strLabel == "$SO_REDEEM")
		{
			ProcessOfferStampRedeemLine(&csvLine);
		}

		switch (Server.GetLoyaltyLogSaveType())
		{
		case 1:
			arrayLogSave.Add(csvLine.GetLine());
			break;

		case 2:
			if ( strLabel == "$ITEM")
			{
				int nSize = csvLine.GetSize();
				
				if ( nSize > 5 )
				{
					csvLine.RemoveAt(5, nSize - 5);
				}
			}
			arrayLogSave.Add(csvLine.GetLine());
			break;
		}

		++nLineCount;
	}

	file.Close();

	switch (Server.GetLoyaltyLogSaveType())
	{
	case 1:
	case 2:
	{
		CString strLogSaveFilename = "";
		strLogSaveFilename.Format("%s\\LOYSAVE.%3.3d",
			(const char*) Server.GetCurrentEposLogPath(),
			m_nTillNo);

		CSSFile fileLogSave;
		if (fileLogSave.Open(strLogSaveFilename, "ab") == TRUE)
		{
			for (int n = 0; n < arrayLogSave.GetSize(); n++)
			{
				fileLogSave.WriteLine(arrayLogSave.GetAt(n));
			}
		}
	}
	break;
	}

	if (m_bMultipleTransactions == TRUE)
	{
		RemoveLines(nLineCount, m_strFilename);				// remove the processed lines
	}

	return m_bValidData;
}

//*******************************************************************

bool CEposLoyaltyFile::ScanLogFileExternal()
{
	CServerWrapper::UpdatePluInfo(1);
	CServerWrapper::UpdateDeptInfo(1);
	CServerWrapper::UpdateStampOfferInfo();
	CServerWrapper::UpdateLoyaltySchemeInfo();

	CString strLabel;
	for (int n = 0; n < m_pExternalLogData->GetSize(); n++)
	{
		CCSV csvLine(m_pExternalLogData->GetAt(n));

		csvLine.Get(0, strLabel);					// get record type

		if (strLabel == "$TRAN")
		{
			if (ProcessTranLine(&csvLine) == FALSE)	// see if valid trans line
			{
				break;
			}
		}
		else if (strLabel == "$PAYM")		ProcessPaymLine(&csvLine);
		else if (strLabel == "$ITEM")		ProcessItemLine(&csvLine);
		else if (strLabel == "$LDISC")		ProcessSubtotalDiscountLine(&csvLine);
	}

	return m_bValidData;
}

//*******************************************************************
// remove lines from loynnn.$$1

void CEposLoyaltyFile::RemoveLines ( int nCount, const char* szFilename )
{
	CString strSourceFile = szFilename;
	CString strTempFile = strSourceFile.Left(strSourceFile.GetLength()-3);	// loose '$$1'
	strTempFile += "$$2";

	int nLinesIn = 0;
	int nLinesOut = 0;

	CSSFile fileIn;
	if (fileIn.Open(strSourceFile, "rb") == TRUE)
	{
		bool bOk = TRUE;
		CString strBuf = "";

		while ((bOk = fileIn.ReadLine(strBuf)) == TRUE)
		{
			if (++nLinesIn == nCount)
			{
				break;
			}
		}

		if (bOk == FALSE)
		{
			fileIn.Close();								// not reached required number of lines to remove
			return;
		}

		CSSFile fileOut;
		if (fileOut.Open(strTempFile, "wb") == TRUE)
		{
			while (fileIn.ReadLine(strBuf) == TRUE)
			{
				if (fileOut.WriteString(strBuf) == TRUE)
				{
					++nLinesOut;
				}
			}
			fileOut.Close();
			fileIn.Close();

			::remove(strSourceFile);						// delete orginal .$$1
			::rename(strTempFile, strSourceFile);		// rename $$2 to $$1
		}
	}
}

//*******************************************************************
// $TRAN,00001,1,1,001000195,250,1,1,19/07/07,11:22:04,2

bool CEposLoyaltyFile::ProcessTranLine ( CCSV* pCsv )
{
	m_bValidData = TRUE;							// assume data ok
	m_strEposCardNo = pCsv->GetString(1);			// get card number passed in log file ( used by New balance on receipt)
	
	if (FALSE == m_bExternalMode)
	{
		switch( System.GetInterfaceType() )
		{
		//case nINTERFACE_MIFAREv3:
		//	nInterfaceType = nINTERFACE_SWIPEv1;
		//	break;

		case nINTERFACE_MIFAREv1:
		case nINTERFACE_MIFAREv2:
			if ( System.GetPaxtonModeFlag() == TRUE )
			{
				if ( m_strEposCardNo.GetLength() >= 9 )
				{
					m_strEposCardNo = m_strEposCardNo.Right(8);
					m_strEposCardNo.TrimLeft('0');
				}
			}
			break;
		}

		int nInterfaceType = System.GetInterfaceType();
		if ( (m_strEposCardNo.Left(4) == "1033") && ( Server.GetSimpsInnsLookupFlag() == TRUE ))
		{
			nInterfaceType = nINTERFACE_SIMPSINNS;
		}

		CAccountIdentifier AccountIdentifier(m_strEposCardNo, nInterfaceType);
		
		CString strError = System.TranslateCardNo(AccountIdentifier, m_strCustomerCardNo);			// extract database record number
		if (strError != "")
		{
			m_bValidData = FALSE;
			m_strError.Format("#ERR,%s", 
				(const char*) strError);
			
			return FALSE;
		}
	}
	else
	{
		m_strCustomerCardNo = m_strEposCardNo;
	}

	if (Sysset.IsNobbledDemo() == TRUE)
	{
		if ((rand() % 10) == 5)
		{
			m_strCustomerCardNo = "1";
		}
	}

	pCsv->Get ( 2, m_nTillNo );							// till number
	pCsv->Get ( 3, m_nServerNo );						// Server Number
	pCsv->Get ( 4, m_strTransactionNo );				// transaction number 9digits

	m_nStaffGiftServerNo = m_nServerNo;

	m_dCashSpend = pCsv->GetDouble(5) / 100;			// assume transaction paid by cash, until a $Paym14
	
	if (m_dCashSpend < 0.0)
	{
		m_nTransactionAppNo = APPNO_REFUNDSALE;			// negative sale = refund
	}

	CString strDate = "";
	CString strBuf = "";
	pCsv->Get ( 8, strBuf );							// date last used dd/mm/yy
	if ( strBuf.GetLength() == 8 )
	{
		CString strTmp;
		strTmp = strBuf.Right(2);						// get year

		int nYear = atoi ( (const char*)strTmp );		// adjust to yyyy
		
		if (nYear > 96)
		{
			nYear += 1900;
		}
		else
		{
			nYear += 2000;
		}

		strDate.Format ( "%6.6s%4.4d", 
			(const char*) strBuf, 
			nYear ); 

		SQLStampOfferBuffer.SetAwardDate(strBuf);
	}
	else
	{
		strDate = strBuf;
	}

	m_dateTransaction.SetDate ( strDate );

	pCsv->Get ( 9, strBuf );							// time last used (hh:mm:ss)
	m_timeTransaction.SetTime ( strBuf );

	m_nTransactionPoints = pCsv->GetInt(10);			// points awarded / Redeemed ) if negative )

	bool bIgnoreTransactionPoints = FALSE;

	if (m_nTransactionPoints > 0)
	{
		bIgnoreTransactionPoints = (Server.GetSPosPointsAwardFlag() == FALSE);
	}
	else if (m_nTransactionPoints < 0)
	{
		bIgnoreTransactionPoints = (Server.GetSPosPointsRedeemFlag() == FALSE);
	}

	if (TRUE == bIgnoreTransactionPoints)
	{
		if (Server.GetSPosPointsNoLogFlag() == FALSE)
		{
			CCSV csvIgnore;
			csvIgnore.Add(pCsv->GetString(8)); //DATE
			csvIgnore.Add(pCsv->GetString(9)); //TIME
			csvIgnore.Add(pCsv->GetString(1)); //CARD NO
			csvIgnore.Add(pCsv->GetString(2)); //TILL NO
			csvIgnore.Add(pCsv->GetString(4)); //TRAN NO
			csvIgnore.Add(pCsv->GetString(5)); //VALUE
			csvIgnore.Add(pCsv->GetString(10)); //POINTS

			CSSFile fileLog;
			if (fileLog.Open(Filenames.GetBlockedPosPointsFilename(), "ab") == TRUE)
			{
				fileLog.WriteLine(csvIgnore.GetLine());
				fileLog.Close();
			}
		}

		m_nTransactionPoints = 0;
	}
	
	return TRUE;
}

/******************************************************************************/
// Payment line - $PAYM,14,Loyalty,250,{PaymentMethodType}
//				- $PAYM,20,Cashless biometric,250,{PaymentMethodType}
//
// PaymentMethodType = 0(cash),1(cheque),2(eft),3(eftCNP),4(PostToRoom),5(PostToRoomManual),6(LoyaltyPoints),7(currency),8(FromDeposit),9(eft(bill lodging)),99(other)

void CEposLoyaltyFile::ProcessPaymLine ( CCSV* pCsv )
{
	bool bOK = FALSE;

	if (pCsv->IsEmpty(4) == FALSE)						// look at PaymentMethodType
	{
		bOK = (pCsv->GetInt(4) == 6) ? TRUE : FALSE;		// Loyalty Points \ Biometric
	}
	else
	{
		bOK = (pCsv->GetInt(1) == 14) ? TRUE : FALSE;		// Loyalty
	}

	if ( bOK == TRUE )
	{
		if (Server.GetNoPurseBonusFlag() == TRUE)
		{
			m_bAllowPluOrDeptBonus = FALSE;					// ignore any plu points allocated
		}

		double dValue = pCsv->GetDouble(3) / 100;			// amount spent from purse (implied 2dps)
		m_dCardSpend += dValue;
		m_dCashSpend -= dValue;								// deduct card spend ( don't know which purse as yet ) from total transaction value
	}
}

//*******************************************************************
// $ITEM,00001,00000010,1,250				old format	
// $ITEM,1,05000010,1,500,'OPEN DRINK'		SPOS (v1516)

void CEposLoyaltyFile::ProcessItemLine(CCSV* pCsv)
{
	CString strPluNo = pCsv->GetString(2);				// plu sold
	double dQty = pCsv->GetDouble(3);				// quantity sold
	double dValue = pCsv->GetDouble(4);				// value of 1 item sold

	dValue = (dValue * dQty) / 100;						//v2.04a  16/06/2015

	strPluNo.TrimLeft('0');									// remove leading 0's

	bool bGotRenew = FALSE;
	bool bGotRevalue = FALSE;
	bool bGotStaffGift = FALSE;
	bool bAttemptedStaffGift = FALSE;

	//CHECK FOR REDIRECTION OF STAFF GIFT
	{
		__int64 nRedirGiftPluNo = _atoi64(Server.GetStaffGiftRedirectPluNo());
		if (nRedirGiftPluNo > 0)
		{
			nRedirGiftPluNo *= 10000;
			__int64 nThisPluNo = _atoi64(strPluNo);

			if ((nThisPluNo >= nRedirGiftPluNo + 1) && (nThisPluNo <= nRedirGiftPluNo + 9999))
			{
				m_nStaffGiftServerNo = static_cast<int>(nThisPluNo - nRedirGiftPluNo);
			}
		}
	}

	//CHECK FOR REVALUATION PLU
	for (int p = 1; p <= 2; p++)
	{
		for (int n = 1; n <= REVALUE_PLUNO_PERPURSE_COUNT; n++)
		{
			if (strPluNo == Server.GetTopupPluNo(p, n))
			{
				m_dAddToCardValue[p][n] += dValue;
				bGotRevalue = TRUE;
				break;
			}
		}
	}

	//CHECK FOR STAFF GIFT UNLESS ALREADY GOT TOPUP
	if (FALSE == bGotRevalue)
	{
		m_bGotItemLine = TRUE;

		if (strPluNo == Server.GetStaffGiftPluNo())
		{
			bAttemptedStaffGift = TRUE;

			//PRELOAD POTENTIAL STAFF GIFT EXCEPTION
			CSQLRowStaffGiftException RowException;
			RowException.SetErrorCode(0);
			RowException.SetServerID(0);
			RowException.SetDate(m_dateTransaction.GetDate());
			RowException.SetTime(m_timeTransaction.GetTime());
			RowException.SetFolderIndexDbNo(m_FolderSetIndex.m_nDbNo);
			RowException.SetFolderIndexSetNo(m_FolderSetIndex.m_nSetNo);
			RowException.SetServerNo(m_nStaffGiftServerNo);
			RowException.SetCustomerID(_atoi64(m_strCustomerCardNo));
			RowException.SetValue(dValue);

			SQLStaffAccountBuffer.BufferStaffGift(RowException);
		}
	}

	//CHECK FOR RENEWAL PLU (CAN BE SAME AS REVALUATION PLU)
	if (FALSE == bAttemptedStaffGift)
	{
		for (int n = 1; n <= RENEW_PLUNO_COUNT; n++)
		{
			if (strPluNo == Server.GetRenewPluNo(n))
			{
				m_nRenewCount[n] += int(dQty);
				bGotRenew = TRUE;
				break;
			}
		}
	}

	if ( /*( TRUE == bGotRenew ) ||*/ (TRUE == bGotRevalue))
	{
		m_dCashSpend -= dValue;								// deduct special PLU value from total transaction value
	}
	else
	{
		CSQLRowPluInfo RowPluInfo;
		RowPluInfo.SetDbNo(m_FolderSetIndex.m_nDbNo);
		RowPluInfo.SetPluNo(_atoi64(strPluNo));

		CSQLRepositoryPluInfo repoInfo;
		bool bExists = (repoInfo.SelectRow(RowPluInfo, NULL).GetSQLError() == SQLCRUD_ERR_NONE);

		CString strText = pCsv->GetString(5);				// see if text passed

		if (strText != "")
		{
			strText.TrimLeft('\x027');					// remove leading '
			strText.TrimRight('\x027');					// remove trailing '
		}

		if (dValue < 0)
		{
			dQty = -(dQty);
		}

		int nPoints = 0;
		CString strBasePlu = "";
		bool bExcludedFromBonus = FALSE;

		if (bExists == TRUE)
		{
			strBasePlu = RowPluInfo.GetMicrotrendBasePluNo(FALSE);
			if (strText == "")
			{
				strText = RowPluInfo.GetDescription();
			}

			if (FALSE == bAttemptedStaffGift)
			{
				if ((Server.GetEnablePluBonusFlag() == TRUE) && (m_bAllowPluOrDeptBonus == TRUE))		// see if using plu points per product
				{
					// add to total transaction points
					nPoints = RowPluInfo.GetPoints() * (int)dQty;
					m_nPluPoints += nPoints;

					if ((nPoints != 0) && (Server.GetRewardNoBonusWithPluPointsFlag() == TRUE))
					{
						m_dGeneralBonusExcludedSpend += dValue;
						bExcludedFromBonus = TRUE;
					}
				}
			}
		}
		else
		{
			RowPluInfo.SetModType(0);
			strBasePlu = RowPluInfo.GetMicrotrendBasePluNo(FALSE);									// unknown Plu 
			if (strText == "")
			{
				strText.Format("Plu %s",
					(const char*)strPluNo);
			}
		}

		if (Server.GetPurchaseHistoryFlag() == TRUE)
		{
			int nType = 0;								// 0=plu, 1=dept, 2=discount
			m_TLogRecordPurchase.SaveItemData(nType, strBasePlu, strText, dQty, dValue, nPoints, bGotRenew ? 1 : 0);
		}

		int nDeptNo = -1;
		if (pCsv->GetSize() >= 7)
		{
			//ENHANCED+ LINE FORMAT INCLUDES DEPARTMENT
			nDeptNo = pCsv->GetInt(6);
		}

		if (nDeptNo >= 0)
		{

			//DEPARTMENT BONUS BUFFER
			if (Server.GetEnableDeptBonusFlag() && m_bAllowPluOrDeptBonus)
			{
				if ((Server.GetRewardNoBonusWithPluPointsFlag() == FALSE) || (0 == nPoints))
				{
					CConsolidatedDoubleByInt item;
					item.m_nKey = nDeptNo;
					item.m_dVal = dValue;
					m_arrayDeptSpendBuffer.Consolidate(item);
				}
			}

			//IF THE ITEM SALE HAS NOT ALREADY BEEN EXCLUDED FROM THE BONUS BECAUSE OF PLU POINTS
			//THEN CHECK TO SEE IF IT SHOULD BE EXCLUDED BECAUSE OF THE DEPARTMENT.
			if (FALSE == bExcludedFromBonus)
			{
				CSQLRowDeptInfo RowDeptInfo;
				RowDeptInfo.SetDbNo(m_FolderSetIndex.m_nDbNo);
				RowDeptInfo.SetDeptNo(nDeptNo);

				CSQLRepositoryDeptInfo repoInfo;
				if (repoInfo.SelectRow(RowDeptInfo, NULL).GetSQLError() == SQLCRUD_ERR_NONE)
				{
					if (RowDeptInfo.GetGeneralSpendBonusFlag() == FALSE)
					{
						m_dGeneralBonusExcludedSpend += dValue;
					}
				}
			}
		}
	}
}

//*******************************************************************

void CEposLoyaltyFile::ProcessOfferStampAwardLine(CCSV* pCsv)
{
	__int64 nPluNo = pCsv->GetInt64(1);
	CString strPluDescription = pCsv->GetString(2);
	int nQty = pCsv->GetInt(3);
	int nStampOfferID = pCsv->GetInt(4);

	if (nQty <= 0)
	{
		return;
	}

	if (strPluDescription != "")
	{
		strPluDescription.TrimLeft('\x027');					// remove leading '
		strPluDescription.TrimRight('\x027');					// remove trailing '
	}

	if (strPluDescription == "")
	{
		CSQLRowPluInfo RowPluInfo;
		RowPluInfo.SetPluNo(nPluNo);

		CSQLRepositoryPluInfo repoInfo;
		if (repoInfo.SelectRow(RowPluInfo, NULL).GetSQLError() == SQLCRUD_ERR_NONE)
		{
			strPluDescription = RowPluInfo.GetDescription();
		}
	}

	if ((nStampOfferID < StampOfferInfo::StampOfferID.Min) || (nStampOfferID > StampOfferInfo::StampOfferID.Max))
	{
		return;
	}

	CSQLRowStampOfferInfo RowSO;
	if (m_StampOfferCache.GetStampOfferRow(nStampOfferID, RowSO) == FALSE)
	{
		return;
	}

	if (RowSO.GetEnableFlag() == FALSE)
	{
		return;
	}

	CSQLStampOfferPendingInfo info;
	info.m_nOfferID = nStampOfferID;
	info.m_nEdition = RowSO.GetEdition();
	info.m_strOfferName = RowSO.GetDisplayDescription();
	info.m_nExpiry = RowSO.GetExpiry();
	info.m_nLineStamps = nQty;
	info.m_nPluNo = nPluNo;
	info.m_strPluDescription = strPluDescription;
	info.m_nPluQty = nQty;

	SQLStampOfferBuffer.BufferAward(info);
}

//*******************************************************************

void CEposLoyaltyFile::ProcessOfferStampRedeemLine(CCSV* pCsv)
{
	__int64 nPluNo = pCsv->GetInt64(1);
	CString strPluDescription = pCsv->GetString(2);
	int nQty = pCsv->GetInt(3);
	int nStampOfferID = pCsv->GetInt(4);

	if (nQty <= 0)
	{
		return;
	}

	if (strPluDescription != "")
	{
		strPluDescription.TrimLeft('\x027');					// remove leading '
		strPluDescription.TrimRight('\x027');					// remove trailing '
	}

	if (strPluDescription == "")
	{
		CSQLRowPluInfo RowPluInfo;
		RowPluInfo.SetPluNo(nPluNo);

		CSQLRepositoryPluInfo repoInfo;
		if (repoInfo.SelectRow(RowPluInfo, NULL).GetSQLError() == SQLCRUD_ERR_NONE)
		{
			strPluDescription = RowPluInfo.GetDescription();
		}
	}

	if ((nStampOfferID < StampOfferInfo::StampOfferID.Min) || (nStampOfferID > StampOfferInfo::StampOfferID.Max))
	{
		return;
	}

	CSQLRowStampOfferInfo RowSO;
	if (m_StampOfferCache.GetStampOfferRow(nStampOfferID, RowSO) == FALSE)
	{
		return;
	}

	if (RowSO.GetThreshold() <= 0)
	{
		return;
	}

	CSQLStampOfferPendingInfo info;
	info.m_nOfferID = RowSO.GetStampOfferID();
	info.m_nEdition = RowSO.GetEdition();
	info.m_strOfferName = RowSO.GetDisplayDescription();
	info.m_nExpiry = RowSO.GetExpiry();
	info.m_nLineStamps = RowSO.GetThreshold() * nQty * (-1);
	info.m_nPluNo = nPluNo;
	info.m_strPluDescription = strPluDescription;
	info.m_nPluQty = nQty;
	SQLStampOfferBuffer.BufferRedeem(info);
}

//*******************************************************************
// $LDISC,0600101537,-231,D,2000

void CEposLoyaltyFile::ProcessSubtotalDiscountLine ( CCSV* pCsv )
{
	double dDiscount = pCsv->GetDouble(2) / 100;
	m_dTotalDiscount += dDiscount;

	if ( Server.GetPurchaseHistoryFlag() == TRUE )	
	{
		m_TLogRecordPurchase.SaveItemData ( 2, "", "Discount", 1, dDiscount, 0, 0 );
	}
}

//******************************************************************

void CEposLoyaltyFile::ProcessItemDiscountLine(CCSV* pCsv)
{
	double dDiscount = pCsv->GetDouble(3) / 100;
	m_dTotalDiscount += dDiscount;

	if (Server.GetPurchaseHistoryFlag() == TRUE)	
	{
		CSQLRowPluInfo RowPluInfo;
		RowPluInfo.SetDbNo(m_FolderSetIndex.m_nDbNo);
		RowPluInfo.SetPluNo(_atoi64(pCsv -> GetString(2)));

		CSQLRepositoryPluInfo repoInfo;
		bool bExists = (repoInfo.SelectRow(RowPluInfo, NULL).GetSQLError() == SQLCRUD_ERR_NONE);

		CString strBasePlu = "";

		if (bExists == FALSE)
		{
			RowPluInfo.SetModType(0);
		}

		strBasePlu = RowPluInfo.GetMicrotrendBasePluNo(FALSE);
	
		m_TLogRecordPurchase.SaveItemData(3, strBasePlu, pCsv -> GetString(6), 1, dDiscount, 0, 0);
	}
}

//******************************************************************

void CEposLoyaltyFile::UpdateLoyaltyAccount(CSQLRowAccountFull& RowAccount, bool bNewDbRecord)
{
	m_arrayPendingAudit.RemoveAll();
	m_nPointsAwarded = 0;
	m_dBonusCash = 0.0;
	m_bGroupDisablePluBonus = FALSE;
	m_bGroupDisableDeptBonus = FALSE;
	m_nBonusMultiplier = 1;

	//PURSE 1 MUST BE ALLOWED AS FALLBACK FOR OVERDRAFT
	//BUT MAY BE DISALLOWED AS PRIORITY PURSE
	bool bUseSystemLoyalty = TRUE;
	bool bIsPurse1PriorityAllowed = TRUE;
	bool bIsPurse2Allowed = FALSE;
	bool bIsRedeemDisabled = Server.GetRedeemDisableAutoFlag();

	CRedeemPoints pointsRedeemer;									// points redeem

	m_atc.SetSQL(RowAccount);										// set audit record to database record
	m_atc.SetTerminalNo(m_nTillNo);
	m_atc.SetOperatorNo(m_nServerNo);
	m_atc.SetEposTranNo(m_strTransactionNo);
	m_atc.SetFolderSetIndex(m_FolderSetIndex);

	//*************************************************************************

	m_bRewardIncludeCashSpend = Server.GetRewardCashSpendFlag();
	m_bRewardIncludePurse1Spend = Server.GetRewardPurse1SpendFlag();
	m_bRewardIncludePurse2Spend = Server.GetRewardPurse2SpendFlag();
	m_dRewardMultiplierTrigger = Server.GetRewardMultiplierTrigger();

	// see if using group specific **********************************************

	CSQLRowGroup RowGroup;
	RowGroup.SetGroupNo(RowAccount.GetGroupNo());

	CSQLRepositoryGroup repoGroup;
	bool bGotGroup = (repoGroup.SelectRow(RowGroup, NULL).GetSQLError() == SQLCRUD_ERR_NONE);

	if (TRUE == bGotGroup)
	{
		bIsPurse1PriorityAllowed = RowGroup.IsPurseAllowedAtTime(1, m_timeTransaction);
		bIsPurse2Allowed = RowGroup.IsPurseAllowedAtTime(2, m_timeTransaction);
		m_bGroupDisablePluBonus = RowGroup.GetNoPluBonusFlag();
		m_bGroupDisableDeptBonus = RowGroup.GetNoDeptBonusFlag();
	}

	GetRevalueSettings(RowGroup, bGotGroup);
	GetRewardSettings(RowGroup, bGotGroup);
	GetRedeemSettings(RowGroup, bGotGroup, bIsRedeemDisabled, pointsRedeemer);

	// see if its a new record added to database ********************

	if (bNewDbRecord == TRUE)
	{
		m_atc.SetSourceType(GetAuditType());
		m_atc.SetApplicationNo(APPNO_INSERT);			// new record inserted in database
		SaveAuditCustomer(RowAccount);
	}

	//*** set last used date & time ***********************************

	if (m_dateTransaction.IsSet() == TRUE)
	{
		m_atc.SetDateLastUsed(m_dateTransaction.GetDate());
		m_atc.SetTimeLastUsed(m_timeTransaction.GetTime());
	}

	CalculatePurseSpend(RowAccount, RowGroup, bIsPurse1PriorityAllowed, bIsPurse2Allowed);

	for (int p = 1; p <= 2; p++)
	{
		for (int n = 1; n <= REVALUE_PLUNO_PERPURSE_COUNT; n++)
		{
			ProcessRevaluation(RowAccount, p, n);
		}
	}

	ProcessRenewalItems(RowAccount);

	{
		bool bTriedStaffGift = FALSE;

		for (int n = 0; n < SQLStaffAccountBuffer.GetStaffGiftCount(); n++)
		{
			if (SQLStaffAccountBuffer.PrepareAuditStaffGift(n, m_atc, GetAuditType()) == TRUE)
			{
				SaveAuditInternal();
				bTriedStaffGift = TRUE;
			}
		}

		if (TRUE == bTriedStaffGift)
		{
			m_atc.SetSQL(RowAccount, AUDIT_PC, TRUE);
		}
	}

	m_nBonusMultiplier = GetBonusMultiplier();			// get bonus multipler factor

	int nNewPoints = 0;
	int nRedeemedPoints = 0;									// if set - they will be negative

	if (FALSE == m_bGroupDisablePluBonus)							// check group is allowed to collect plu points
	{
		if (Server.GetEnablePluBonusFlag() == TRUE)				// see if using plu points
		{
			nNewPoints = m_nPluPoints * m_nBonusMultiplier;			// apply bonus mulipler to plu points
		}
		else if (m_nTransactionPoints > 0)						// use points passed by till if +ve
		{
			nNewPoints = m_nTransactionPoints;
		}
	}

	if (m_nTransactionPoints < 0)								// if -ve, points have been used at till
	{
		nRedeemedPoints = m_nTransactionPoints;
	}

	if ((m_dPurse1Spend != 0.0) ||
		(m_dPurse2Spend != 0.0) || 
		(m_dCashSpend != 0.0) || 
		(nNewPoints != 0) || 
		(nRedeemedPoints != 0) ||
		( TRUE == m_bGotItemLine ) )
	{
		ProcessPurse1Spend(RowAccount, RowGroup);
		ProcessPurse2Spend(RowAccount, RowGroup);
		ProcessCashSpend(RowAccount, RowGroup);

		if (nNewPoints > 0)
		{
			RowAccount.UpdatePoints(nNewPoints);				// add plu points to points & pointsTD ( if any )
			m_atc.SetPointsTransaction(nNewPoints);		// new points awarded
		}
		else
		{
			m_atc.SetPointsTransaction(0);
		}

		m_atc.SetPurse1Transaction(-(m_dPurse1Spend));
		m_atc.SetPurse2Transaction(-(m_dPurse2Spend));
		m_atc.SetCashTransaction(-(m_dCashSpend));
		m_atc.SetTotalDiscount(-(m_dTotalDiscount));
		m_atc.SetSourceType(GetAuditType());
		m_atc.SetApplicationNo(m_nTransactionAppNo);		// card sale or refund
		SaveAuditCustomer(RowAccount);

		m_nTransactionCCNo = m_atc.GetCCNo();				// get CCNo used to save epos sale for use by purchase history
		m_nPointsAwarded += nNewPoints;

		if (nRedeemedPoints < 0)							// see if points redeemed at till
		{
			RowAccount.AddToPoints(nRedeemedPoints);			// redeemed points are negative
			m_atc.SetPointsTransaction(nRedeemedPoints);	// points redeemed
			m_atc.SetPurse1Transaction(0.00);
			m_atc.SetPurse2Transaction(0.0);
			m_atc.SetCashTransaction(0.0);
			m_atc.SetSourceType(GetAuditType());
			m_atc.SetApplicationNo(APPNO_REDEEM);		// Epos free item points redemption
			SaveAuditCustomer(RowAccount, Server.GetRedeemComment());
		}
	}

	ProcessReward(RowAccount);

	if ((Server.GetEnableDeptBonusFlag() == TRUE) &&
		(FALSE == m_bGroupDisableDeptBonus) && //NOT BLOCKED BY GROUP
		(TRUE == m_bAllowPluOrDeptBonus)) //NOT BLOCKED BY PURSE SPEND
	{
		ProcessDeptReward(RowAccount);
	}

	if (FALSE == bIsRedeemDisabled)
	{
		AutoRedeemPoints(RowAccount, &pointsRedeemer);
	}
}

//*******************************************************************

void CEposLoyaltyFile::GetRevalueSettings(CSQLRowGroup& RowGroup, bool bGotGroup)
{
	for (int p = 1; p <= 2; p++)
	{
		for (int n = 1; n <= REVALUE_PLUNO_PERPURSE_COUNT; n++)
		{
			m_RevaluationInfo[p][n].m_dTrip = Server.GetTopupBonusTrip(p,n);
			m_RevaluationInfo[p][n].m_nType = Server.GetTopupBonusType(p, n);
			m_RevaluationInfo[p][n].m_nPoints = Server.GetTopupBonusPoints(p, n);
			m_RevaluationInfo[p][n].m_dValue = Server.GetTopupBonusValue(p, n);
			m_RevaluationInfo[p][n].m_nPercent = Server.GetTopupBonusPercent(p, n);
		}
	}

	if (FALSE == bGotGroup)
	{
		return;
	}

	CSQLRecordSetGroupTopupBonus RecordSetBonus(NULL, 
		RSParams_GroupTopupBonus_NormalByGroupNo{RowGroup.GetGroupNo()});

	CSQLRowGroupTopupBonus RowBonus;
	while (RecordSetBonus.StepSelectAll(RowBonus) == TRUE)
	{
		int nPurseNo = RowBonus.GetPurseNo();
		if ((nPurseNo != 1) && (nPurseNo != 2))
		{
			continue;
		}

		int nTopupNo = RowBonus.GetTopupNo();
		if ((nTopupNo < 1) || (nTopupNo > REVALUE_PLUNO_PERPURSE_COUNT))
		{
			continue;
		}

		if (RowBonus.GetBonusFlag() == TRUE)
		{
			if (RowBonus.GetBonusDisable() == TRUE)
			{
				m_RevaluationInfo[nPurseNo][nTopupNo].m_dTrip = 0.0;
			}
			else
			{
				m_RevaluationInfo[nPurseNo][nTopupNo].m_dTrip = RowBonus.GetBonusTrip();
				m_RevaluationInfo[nPurseNo][nTopupNo].m_nType = RowBonus.GetBonusType();
				m_RevaluationInfo[nPurseNo][nTopupNo].m_nPoints = RowBonus.GetBonusPoints();
				m_RevaluationInfo[nPurseNo][nTopupNo].m_dValue = RowBonus.GetBonusValue();
				m_RevaluationInfo[nPurseNo][nTopupNo].m_nPercent = RowBonus.GetBonusPercent();
			}
		}
	}
}

//*******************************************************************

void CEposLoyaltyFile::GetRewardSettings(CSQLRowGroup& RowGroup, bool bGotGroup)
{
	bool bUseSystemReward = TRUE;

	if (TRUE == bGotGroup)
	{
		if (RowGroup.GetRewardFlag() == TRUE)				// loyalty points bonus
		{
			bUseSystemReward = FALSE;

			if (RowGroup.GetRewardDisable() == TRUE)			// see if disabled for this group
			{
				m_dRewardTrip = 0;
			}
			else
			{
				m_dRewardTrip = RowGroup.GetRewardTrip();
				m_nRewardType = RowGroup.GetRewardType();
				m_nRewardPoints = RowGroup.GetRewardPoints();
				m_dRewardValue = RowGroup.GetRewardBonus();
				m_dRewardUpperSpendLimit = RowGroup.GetRewardLimit();

				double dMinimumSpend = RowGroup.GetRewardTrigger();

				if (dMinimumSpend != 0)
				{
					m_dRewardMultiplierTrigger = dMinimumSpend;
				}
			}
		}
	}

	if (TRUE == bUseSystemReward)
	{
		m_dRewardTrip = Server.GetRewardTrip();
		m_nRewardType = Server.GetRewardType();
		m_nRewardPoints = Server.GetRewardPoints();
		m_dRewardValue = Server.GetRewardValue();
		m_dRewardUpperSpendLimit = Server.GetRewardUpperSpendLimit();
	}

	m_bHaveRewardUpperSpendLimit = (m_dRewardUpperSpendLimit != 0);
}

//*******************************************************************

void CEposLoyaltyFile::GetRedeemSettings(CSQLRowGroup& RowGroup, bool bGotGroup, bool& bRedeemDisabled, CRedeemPoints& pointsRedeemer)
{
	bool bUseSystemRedeem = TRUE;

	if (TRUE == bGotGroup)
	{
		if (RowGroup.GetRedeemFlag() == TRUE)							// group specifc redeem points
		{
			bUseSystemRedeem = FALSE;
			if (bRedeemDisabled == FALSE)									// check not disabled system wide
			{
				bRedeemDisabled = RowGroup.GetRedeemDisable();				// individual group could be disabled
			}

			pointsRedeemer.m_nTrip = RowGroup.GetRedeemTrip();
			pointsRedeemer.m_dValue = RowGroup.GetRedeemValue();
			pointsRedeemer.m_nType = RowGroup.GetRedeemType();			// redeem type Standard\Family
		}
	}

	if (TRUE == bUseSystemRedeem)
	{
		pointsRedeemer.m_nTrip = Server.GetRedeemPointsTrip();
		pointsRedeemer.m_dValue = Server.GetRedeemPointsValue();
		pointsRedeemer.m_nType = Server.GetRedeemPointsType();		// type = Standard \ Family
	}
}

//*******************************************************************

void CEposLoyaltyFile::CalculatePurseSpend(CSQLRowAccountFull& RowAccount, CSQLRowGroup& RowGroup, bool bIsPurse1PriorityAllowed, bool bIsPurse2Allowed)
{
	if (m_dCardSpend < 0.0)									// see if refund
	{
		m_dPurse1Spend = m_dCardSpend;							// add refund to Purse1
	}
	else if (m_dCardSpend > 0.0)								// see if any spend from card
	{
		if (bIsPurse2Allowed == TRUE)
		{
			if (LoyaltySubs.IsRefreshPurse2Reqd(RowAccount, RowGroup, m_dateTransaction) == TRUE)	// see if purse2 needs refreshing
			{
				RowAccount.RefreshPurse2(RowGroup.GetRefreshValue(), m_dateTransaction.GetDate(), m_timeTransaction.GetTime());		// Set purse2 in database record

				m_atc.SetPurse2Transaction(RowAccount.GetPurse2Balance());			// set refresh value
				m_atc.SetPurse2(RowAccount.GetPurse2Balance());					// set new purse2 balance	
				m_atc.SetSourceType(AUDIT_SERVER);
				m_atc.SetApplicationNo(APPNO_REFRESH);
				SaveAuditCustomer(RowAccount);
			}
		}

		bool bPurse1Priority = TRUE;
		bPurse1Priority &= bIsPurse1PriorityAllowed;
		bPurse1Priority &= Server.GetSpendUsePurse1FirstFlag();

		if (FALSE == bPurse1Priority)
		{
			double dPurse2 = (bIsPurse2Allowed) ? RowAccount.GetPurse2Balance() : 0;	// purse2 value that can be used

			if (dPurse2 == 0.0)									// no purse2
			{
				m_dPurse1Spend = m_dCardSpend;						// all spend from purse1
			}
			else if (dPurse2 >= m_dCardSpend)
			{
				m_dPurse2Spend = m_dCardSpend;						// all spend from purse2
			}
			else
			{
				m_dPurse2Spend = dPurse2;
				m_dPurse1Spend = m_dCardSpend - dPurse2;			// spend split between Purese 1 & 2
			}
		}
		else
		{
			if (FALSE == bIsPurse2Allowed)
			{
				//purse 1 must accept any overdraft
				m_dPurse1Spend = m_dCardSpend;
			}
			else
			{
				double dPurse1 = RowAccount.GetPurse1Balance();
				double dPurse2 = RowAccount.GetPurse2Balance();
				double dSpendToAllocate = m_dCardSpend;

				if (dPurse1 >= dSpendToAllocate)
				{
					//purse 1 can cover entire balance
					m_dPurse1Spend = dSpendToAllocate;
				}
				else
				{
					//use any positive purse 1 balance
					if (CompareDoubles(dPurse1, 0.0, 2) == 1)
					{
						m_dPurse1Spend = dPurse1;
						dSpendToAllocate -= dPurse1;
					}

					if (dPurse2 >= dSpendToAllocate)
					{
						//purse 2 can cover remaining balance
						m_dPurse2Spend = dSpendToAllocate;
					}
					else
					{
						//purse 1 must accept overdraft
						m_dPurse2Spend = dPurse2;
						m_dPurse1Spend += (dSpendToAllocate - dPurse2);
					}
				}
			}
		}
	}
}

//*******************************************************************

void CEposLoyaltyFile::ProcessRevaluation(CSQLRowAccountFull& RowAccount, int nPurseNo, int nTopupNo)
{
	if ((nPurseNo != 1) && (nPurseNo != 2))
	{
		return;
	}

	if ((nTopupNo < 1) || (nTopupNo > REVALUE_PLUNO_PERPURSE_COUNT))
	{
		return;
	}

	double dTopUpAmount = m_dAddToCardValue[nPurseNo][nTopupNo];
	int nAuditType = CAuditReportTexts::GetAppNoAddCash(nPurseNo,nTopupNo);

	if (::CompareDoubles(dTopUpAmount, 0.0, 3) == 0)
	{
		return;
	}

	// add any topup value

	if (nPurseNo != 2)
	{
		RowAccount.AddToPurse1(dTopUpAmount);
		m_atc.SetPurse1Transaction(dTopUpAmount);
		m_atc.SetPurse2Transaction(0.0);
	}
	else
	{
		RowAccount.AddToPurse2(dTopUpAmount);
		m_atc.SetPurse1Transaction(0.0);
		m_atc.SetPurse2Transaction(dTopUpAmount);
	}

	m_atc.SetCashTransaction(0.0);
	m_atc.SetPointsTransaction(0);
	m_atc.SetSourceType(GetAuditType());
	m_atc.SetApplicationNo(nAuditType);			// audit cash added
	SaveAuditCustomer(RowAccount);

	// see if any revaluation bonus is required
	if (CompareDoubles(m_RevaluationInfo[nPurseNo][nTopupNo].m_dTrip, 0.0, 3) != 0)
	{
		switch (m_RevaluationInfo[nPurseNo][nTopupNo].m_nType)
		{
		case 0:
		{
			int nBonusPoints = Server.CalculateRevaluationBonusPoints
			(
				dTopUpAmount,
				m_RevaluationInfo[nPurseNo][nTopupNo].m_dTrip,
				m_RevaluationInfo[nPurseNo][nTopupNo].m_nPoints);

			if (nBonusPoints != 0)
			{
				RowAccount.UpdatePoints(nBonusPoints);
				m_atc.SetPointsTransaction(nBonusPoints);
				m_atc.SetPurse1Transaction(0.0);
				m_atc.SetPurse2Transaction(0.0);
				m_atc.SetCashTransaction(dTopUpAmount);
				m_atc.SetSourceType(AUDIT_SERVER);
				m_atc.SetApplicationNo(APPNO_REVALUEBONUSPOINTS);	// audit bonus points
				SaveAuditCustomer(RowAccount, (2 == nPurseNo) ? Server.GetTopupCommentPurse2() : Server.GetTopupCommentPurse1());

				m_nPointsAwarded += nBonusPoints;
			}
		}
		break;

		case 1:
		{
			double dBonusValue = Server.CalculateRevaluationBonusValue
			(
				dTopUpAmount,
				m_RevaluationInfo[nPurseNo][nTopupNo].m_dTrip,
				m_RevaluationInfo[nPurseNo][nTopupNo].m_dValue);

			if (dBonusValue != 0.0)
			{
				if (nPurseNo != 2)
				{
					RowAccount.AddToPurse1(dBonusValue);
					m_atc.SetPurse1Transaction(dBonusValue);
					m_atc.SetPurse2Transaction(0.0);
				}
				else
				{
					RowAccount.AddToPurse2(dBonusValue);
					m_atc.SetPurse1Transaction(0.0);
					m_atc.SetPurse2Transaction(dBonusValue);
				}

				m_atc.SetCashTransaction(dTopUpAmount);
				m_atc.SetPointsTransaction(0);
				m_atc.SetSourceType(AUDIT_SERVER);
				m_atc.SetApplicationNo(APPNO_REVALUEBONUSCASH);	// audit bonus cash
				SaveAuditCustomer(RowAccount, (2 == nPurseNo) ? Server.GetTopupCommentPurse2() : Server.GetTopupCommentPurse1());

				m_dBonusCash += dBonusValue;
			}
		}
		break;

		case 2:
		{
			double dBonusValue = Server.CalculateRevaluationBonusPercent
			(
				dTopUpAmount,
				m_RevaluationInfo[nPurseNo][nTopupNo].m_dTrip,
				m_RevaluationInfo[nPurseNo][nTopupNo].m_nPercent);

			if (dBonusValue != 0.0)
			{
				if (nPurseNo != 2)
				{
					RowAccount.AddToPurse1(dBonusValue);
					m_atc.SetPurse1Transaction(dBonusValue);
					m_atc.SetPurse2Transaction(0.0);
				}
				else
				{
					RowAccount.AddToPurse2(dBonusValue);
					m_atc.SetPurse1Transaction(0.0);
					m_atc.SetPurse2Transaction(dBonusValue);
				}

				m_atc.SetCashTransaction(dTopUpAmount);
				m_atc.SetPointsTransaction(0);
				m_atc.SetSourceType(AUDIT_SERVER);
				m_atc.SetApplicationNo(APPNO_REVALUEBONUSCASH);	// audit bonus cash
				SaveAuditCustomer(RowAccount, (2 == nPurseNo) ? Server.GetTopupCommentPurse2() : Server.GetTopupCommentPurse1());

				m_dBonusCash += dBonusValue;
			}
		}
		break;
		}
	}
}

//*******************************************************************

void CEposLoyaltyFile::ProcessRenewalItems(CSQLRowAccountFull& RowAccount)
{
	for (int n = 1; n <= RENEW_PLUNO_COUNT; n++)
	{
		int nRenewCount = m_nRenewCount[n];

		if (nRenewCount != 0)
		{
			int nMultiplier = Server.GetRenewMultiplier(n);

			CSSDate dateExpiry(RowAccount.GetExpiryDate());

			{
				CSSDate dateCurrent;
				dateCurrent.SetCurrentDate();

				if ((dateExpiry.IsSet() == FALSE) || (dateExpiry < dateCurrent))
				{
					dateExpiry = dateCurrent;
				}
			}

			COleDateTime oleDateExpire = COleDateTime(dateExpiry.GetYear(), dateExpiry.GetMonth(), dateExpiry.GetDay(), 6, 0, 0);

			CString strRenewType = "";
			switch (Server.GetRenewType(n))
			{
			case 1:
				strRenewType = "W";
				oleDateExpire += COleDateTimeSpan(7 * nMultiplier * nRenewCount, 0, 0, 0);
				break;

			case 2:
			{
				strRenewType = "M";
				int nMonthsToAdd = nMultiplier * nRenewCount;

				int nYear = oleDateExpire.GetYear();
				int nMonth = oleDateExpire.GetMonth();
				int nDay = oleDateExpire.GetDay();

				bool bEndOfMonth = (nDay >= GetMaxDayInMonth(nMonth));

				nYear += (nMonthsToAdd / 12);
				nMonth += (nMonthsToAdd % 12);

				if (nMonth > 12)
				{
					nYear++;
					nMonth -= 12;
				}

				int nMaxDay = GetMaxDayInMonth(nMonth);

				if ((nDay > nMaxDay) || (TRUE == bEndOfMonth))
				{
					nDay = nMaxDay;
					oleDateExpire = COleDateTime(nYear, nMonth, nDay, 0, 0, 0);

					if (nMonth == 2)
					{
						COleDateTime dateLeapYearTest = oleDateExpire + COleDateTimeSpan(1, 0, 0, 0);
						if (dateLeapYearTest.GetMonth() == 2)
						{
							oleDateExpire = dateLeapYearTest;
						}
					}
				}
				else
				{
					oleDateExpire = COleDateTime(nYear, nMonth, nDay, 0, 0, 0);
				}
			}
			break;

			case 3:
				if (Server.GetRenewFixedYear(n) != 0)
				{
					strRenewType = "F";

					int nRenewYear = Server.GetRenewFixedYear(n);
					int nRenewDayNumber = Server.GetRenewYearDayNumber(n);
					AdjustRenewDayNumber(nRenewYear, nRenewDayNumber);

					COleDateTime oleDateExtend = COleDateTime(nRenewYear, 1, 1, 0, 0, 0);
					oleDateExtend += COleDateTimeSpan(nRenewDayNumber - 1, 0, 0, 0);

					if (oleDateExtend.m_status == COleDateTime::valid)
					{
						oleDateExpire = oleDateExtend;
					}
				}
				else
				{
					strRenewType = "A";

					int nGotYear = oleDateExpire.GetYear();
					int nGotMonth = oleDateExpire.GetMonth();
					int nGotDay = oleDateExpire.GetDay();

					//WILL ADJUST FEB 29TH TO FEB 28TH
					int nMaxDay = GetMaxDayInMonth(nGotMonth,FALSE);
					if (nGotDay > nMaxDay)
					{
						nGotDay = nMaxDay;
					}

					//WILL ADJUST FEB 29TH TO FEB 28TH
					int nRenewYearDayNumber = Server.GetRenewYearDayNumber(n);
					AdjustRenewDayNumber(2019, nRenewYearDayNumber);

					COleDateTime gotCompare = COleDateTime(2019, nGotMonth, nGotDay, 0, 0, 0);
					COleDateTime newCompare = COleDateTime(2018, 12, 31, 0, 0, 0) + COleDateTimeSpan(nRenewYearDayNumber, 0, 0, 0);

					int nRenewYear = nGotYear + nRenewCount;
					if (gotCompare < newCompare)
					{
						nRenewYear--;
					}

					nRenewYearDayNumber = Server.GetRenewYearDayNumber(n);
					AdjustRenewDayNumber(nRenewYear, nRenewYearDayNumber);

					oleDateExpire = COleDateTime(nRenewYear, 1, 1, 0, 0, 0);
					oleDateExpire += COleDateTimeSpan(nRenewYearDayNumber - 1, 0, 0, 0);
				}
				break;

			case 0:
			default:
				strRenewType = "D";
				oleDateExpire += COleDateTimeSpan(nMultiplier * nRenewCount, 0, 0, 0);
				break;
			}

			CString strNewExpiryDate;
			strNewExpiryDate.Format("%2.2d%2.2d%4.4d",
				oleDateExpire.GetDay(),
				oleDateExpire.GetMonth(),
				oleDateExpire.GetYear());

			RowAccount.SetExpiryDate(strNewExpiryDate);

			CString strComment = "";
			{
				CString strRenewCount = "";
				if (m_nRenewCount[n] != 1)
				{
					strRenewCount.Format("%dx", m_nRenewCount[n]);
				}

				CString strMultiplier = "";
				if (Server.GetRenewType(n) != 3)
				{
					strMultiplier.Format("x%d", nMultiplier);
				}

				CString strDate = "";
				strDate.Format("(%2.2d/%2.2d/%4.4d)",
					oleDateExpire.GetDay(),
					oleDateExpire.GetMonth(),
					oleDateExpire.GetYear());

				strComment.Format("Renew%d %s%s%s %s",
					n,
					(const char*)strRenewCount,
					(const char*)strRenewType,
					(const char*)strMultiplier,
					(const char*)strDate);
			}

			m_atc.SetPurse1Transaction(0.0);
			m_atc.SetPurse2Transaction(0.0);
			m_atc.SetCashTransaction(0.0);
			m_atc.SetPointsTransaction(0);
			m_atc.SetSourceType(GetAuditType());
			m_atc.SetApplicationNo(APPNO_EXTENDEXPIRE);
			SaveAuditCustomer(RowAccount,strComment);
		}
	}
}

//*******************************************************************

void CEposLoyaltyFile::ProcessPurse1Spend(CSQLRowAccountFull& RowAccount, CSQLRowGroup& RowGroup)
{
	if (m_dPurse1Spend != 0.0)
	{
		bool bClearLastSpend = FALSE;
		CSSDate dateLastUsed(RowAccount.GetPurse1LastSpendDate());	// see if purse1 used today

		if (dateLastUsed != m_dateTransaction)
		{
			bClearLastSpend = TRUE;
		}
		else
		{
			if (RowGroup.GetMaxSpendType() == nSPENDTYPE_PERIOD)
			{
				if (SQLRowSetAuditPeriod.GetPeriodIndex(RowAccount.GetPurse1LastSpendTime()) != SQLRowSetAuditPeriod.GetPeriodIndex(m_timeTransaction.GetTime()))
				{
					bClearLastSpend = TRUE;
				}
			}
		}

		RowAccount.SubtractFromPurse1(m_dPurse1Spend);
		RowAccount.SetPurse1LastSpendDate(m_dateTransaction.GetDate());
		RowAccount.SetPurse1LastSpendTime(m_timeTransaction.GetTime());

		if (bClearLastSpend == TRUE)
		{
			RowAccount.SetPurse1LastSpend(m_dPurse1Spend);
		}
		else
		{
			RowAccount.AddToPurse1LastSpend(m_dPurse1Spend);
		}

		RowAccount.AddToPurse1SpendToDate(m_dPurse1Spend);
	}
}

//*******************************************************************

void CEposLoyaltyFile::ProcessPurse2Spend(CSQLRowAccountFull& RowAccount, CSQLRowGroup& RowGroup)
{
	if (m_dPurse2Spend != 0.0)
	{
		bool bClearLastSpend = FALSE;
		CSSDate dateLastUsed(RowAccount.GetPurse2LastSpendDate());		// see if purse2 used today

		if (dateLastUsed != m_dateTransaction)
		{
			bClearLastSpend = TRUE;
		}
		else
		{
			if (RowGroup.GetMaxSpendType() == nSPENDTYPE_PERIOD)
			{
				if (SQLRowSetAuditPeriod.GetPeriodIndex(RowAccount.GetPurse2LastSpendTime()) != SQLRowSetAuditPeriod.GetPeriodIndex(m_timeTransaction.GetTime()))
				{
					bClearLastSpend = TRUE;
				}
			}
		}

		RowAccount.SubtractFromPurse2(m_dPurse2Spend);
		RowAccount.SetPurse2LastSpendDate(m_dateTransaction.GetDate());
		RowAccount.SetPurse2LastSpendTime(m_timeTransaction.GetTime());

		if (bClearLastSpend == TRUE)
		{
			RowAccount.SetPurse2LastSpend(m_dPurse2Spend);
		}
		else
		{
			RowAccount.AddToPurse2LastSpend(m_dPurse2Spend);
		}

		RowAccount.AddToPurse2SpendToDate(m_dPurse2Spend);
	}
}

//*******************************************************************

void CEposLoyaltyFile::ProcessCashSpend(CSQLRowAccountFull& RowAccount, CSQLRowGroup& RowGroup)
{
	if (m_dCashSpend != 0.0)
	{
		bool bClearLastSpend = FALSE;
		CSSDate dateLastUsed(RowAccount.GetCashLastSpendDate());		// see if cash used today

		if (dateLastUsed != m_dateTransaction)
		{
			bClearLastSpend = TRUE;
		}
		else
		{
			if (RowGroup.GetMaxSpendType() == nSPENDTYPE_PERIOD)
			{
				if (SQLRowSetAuditPeriod.GetPeriodIndex(RowAccount.GetCashLastSpendTime()) != SQLRowSetAuditPeriod.GetPeriodIndex(m_timeTransaction.GetTime()))
				{
					bClearLastSpend = TRUE;
				}
			}
		}

		RowAccount.SetCashLastSpendDate(m_dateTransaction.GetDate());
		RowAccount.SetCashLastSpendTime(m_timeTransaction.GetTime());

		if (bClearLastSpend == TRUE)
		{
			RowAccount.SetCashLastSpend(m_dCashSpend);
		}
		else
		{
			RowAccount.AddToCashLastSpend(m_dCashSpend);
		}

		RowAccount.AddToCashSpendToDate(m_dCashSpend);
	}
}

//*******************************************************************

void CEposLoyaltyFile::ProcessReward(CSQLRowAccountFull& RowAccount)
{
	if (m_dRewardTrip > 0.0)									// see if loyalty bonus setup
	{
		double dRewardableSpendTotal = 0.0;

		if (m_bRewardIncludePurse1Spend == TRUE)
		{
			dRewardableSpendTotal = m_dPurse1Spend;
		}

		if (m_bRewardIncludePurse2Spend == TRUE)
		{
			dRewardableSpendTotal += m_dPurse2Spend;
		}

		if (m_bRewardIncludeCashSpend == TRUE)
		{
			dRewardableSpendTotal += m_dCashSpend;
		}
	
		if (m_bHaveRewardUpperSpendLimit == TRUE)			// see if need to check single transaction upper limit
		{
			if (dRewardableSpendTotal >= m_dRewardUpperSpendLimit)			// check for max spend per transaction
			{
				dRewardableSpendTotal = m_dRewardUpperSpendLimit;
			}
		}

		if (::CompareDoubles(m_dGeneralBonusExcludedSpend,0.0,3) != 0 )
		{
			if ((dRewardableSpendTotal > 0.0) && (m_dGeneralBonusExcludedSpend > 0.0))
			{
				dRewardableSpendTotal -= m_dGeneralBonusExcludedSpend;

				if (dRewardableSpendTotal < 0.0)
				{
					dRewardableSpendTotal = 0.0;
				}
			}
			else if ((dRewardableSpendTotal < 0.0) && (m_dGeneralBonusExcludedSpend < 0.0))
			{
				dRewardableSpendTotal -= m_dGeneralBonusExcludedSpend;

				if (dRewardableSpendTotal > 0.0)
				{
					dRewardableSpendTotal = 0.0;
				}
			}
		}

		if (m_nRewardType == 0)										// bonus points
		{
			int nBonusPoints = CalculateRewardPoints(dRewardableSpendTotal);		// see if any bonus points to apply
			if (nBonusPoints != 0)
			{
				// apply bonus multipler factor
				nBonusPoints *= m_nBonusMultiplier;			
				ProcessBonusPoints(dRewardableSpendTotal, nBonusPoints, RowAccount, APPNO_REWARDBONUSPOINTS, APPNO_REFUNDREWARDBONUSPOINTS);
			}
		}
		else															// bonus cash
		{
			double dBonusValue = CalculateRewardValue(dRewardableSpendTotal);	// see if any bonus cash to apply
			if (dBonusValue != 0.0)
			{
				// apply bonus multipler factor
				dBonusValue *= m_nBonusMultiplier;								
				ProcessBonusCash(dRewardableSpendTotal, dBonusValue, RowAccount, APPNO_REWARDBONUSCASH, APPNO_REFUNDREWARDBONUSCASH );
			}
		}
	}
}

//*******************************************************************

void CEposLoyaltyFile::ProcessDeptReward(CSQLRowAccountFull& RowAccount)
{
	for (int n = 0; n < m_arrayDeptSpendBuffer.GetSize(); n++)
	{
		CConsolidatedDoubleByInt item;
		m_arrayDeptSpendBuffer.GetAt(n, item);

		int nDeptNo = item.m_nKey;
		double dSpend = item.m_dVal;

		if ( CompareDoubles(dSpend, 0.0, 3 ) == 0)
		{
			continue;
		}

		CSQLRowDeptInfo RowDept;

		if (Server.GetEcrManagerGlobalDeptFlag() == TRUE)
		{
			RowDept.SetDbNo(1);
		}
		else
		{
			RowDept.SetDbNo(m_FolderSetIndex.m_nDbNo);
		}

		RowDept.SetDeptNo(nDeptNo);

		CSQLRepositoryDeptInfo repoInfo;
		if ( repoInfo.SelectRow(RowDept,NULL).GetSQLError() != SQLCRUD_ERR_NONE)
		{
			continue;
		}

		double dTrip = RowDept.GetLoyaltyBonusTrip();
		if ( CompareDoubles(dTrip, 0.0, 2) == 0)
		{
			continue;
		}

		if (dSpend < dTrip)
		{
			continue;
		}

		switch (RowDept.GetLoyaltyBonusType())
		{
		case 0:
			//POINTS
			{
				int nPointsPerTrip = RowDept.GetLoyaltyBonusPoints();

				if (nPointsPerTrip != 0)
				{
					int nFactor = (int)(dSpend / dTrip);
					int nPoints = nPointsPerTrip * nFactor;
					ProcessBonusPoints(dSpend, nPoints, RowAccount, APPNO_DEPTBONUSPOINTS, APPNO_REFUNDDEPTBONUSPOINTS);
				}
			}
			break;

		case 1:
			//VALUE
			{
				double dBonusPerTrip = RowDept.GetLoyaltyBonusValue();

				if (::CompareDoubles(dBonusPerTrip, 0.0, 2) != 0)
				{
					int nFactor = (int)(dSpend / dTrip);
					double dBonusValue = dBonusPerTrip * (double)nFactor;
					ProcessBonusCash( dSpend, dBonusValue, RowAccount, APPNO_DEPTBONUSCASH, APPNO_REFUNDDEPTBONUSCASH );
				}
			}
			break;

		case 2:
			//PERCENT
			{
				int nPercent = RowDept.GetLoyaltyBonusPercent();

				if (nPercent != 0)
				{
					double dBonusValue = 0.0;

					if (100 == nPercent)
					{
						dBonusValue = dSpend;
					}
					else
					{
						dBonusValue = (dSpend * double(nPercent)) / 100.0;
					}

					ProcessBonusCash( dSpend, dBonusValue, RowAccount, APPNO_DEPTBONUSCASH, APPNO_REFUNDDEPTBONUSCASH );
				}
			}
			break;
		}
	}
}

//*******************************************************************

void CEposLoyaltyFile::ProcessBonusCash(double dSpend, double dBonus, CSQLRowAccountFull& RowAccount, int nAppNoSale, int nAppNoRefund)
{
	if (Server.CanDoDoubleBonusNow() == TRUE)
	{
		// TEMPORARY HACK TO DOUBLE BONUS IF SET NAME STARTS WITH #
		CString strSetName = Server.GetEposPathLabel(m_FolderSetIndex);
		if (strSetName.Left(1) == "#")
		{
			dBonus *= 2;
		}
	}

	if (CompareDoubles(dBonus, 0.0, 2) != 0)
	{
		bool bBonusToPurse2 = TRUE;
		bBonusToPurse2 &= System.GetEnablePurse2Flag();
		bBonusToPurse2 &= Server.GetSpendBonusToPurse2Flag();

		int nAppNo = (m_nTransactionAppNo == APPNO_REFUNDSALE) ? nAppNoRefund : nAppNoSale;

		if (FALSE == bBonusToPurse2)
		{
			RowAccount.AddToPurse1(dBonus);
			m_atc.SetPurse1Transaction(dBonus);				// cash added to card
			m_atc.SetPurse2Transaction(0.0);
		}
		else
		{
			RowAccount.AddToPurse2(dBonus);
			m_atc.SetPurse1Transaction(0.0);				// cash added to card
			m_atc.SetPurse2Transaction(dBonus);
		}

		m_atc.SetSourceType(AUDIT_SERVER);
		m_atc.SetCashTransaction(dSpend);				// spend that generated the bonus cash
		m_atc.SetPointsTransaction(0);
		m_atc.SetSourceType(AUDIT_SERVER);
		m_atc.SetApplicationNo(nAppNo);					// audit bonus cash

		SaveAuditCustomer(RowAccount, Server.GetRewardComment());
		m_dBonusCash += dBonus;
	}
}

//*******************************************************************

void CEposLoyaltyFile::ProcessBonusPoints(double dSpend, int nPoints, CSQLRowAccountFull& RowAccount, int nAppNoSale, int nAppNoRefund)
{
	if (Server.CanDoDoubleBonusNow() == TRUE)
	{
		// TEMPORARY HACK TO DOUBLE BONUS IF SET NAME STARTS WITH #
		CString strSetName = Server.GetEposPathLabel(m_FolderSetIndex);
		if (strSetName.Left(1) == "#")
		{
			nPoints *= 2;
		}
	}

	if (nPoints != 0)
	{
		RowAccount.UpdatePoints(nPoints);

		m_atc.SetCashTransaction(dSpend);				// spend that generated the bonus cash
		m_atc.SetPurse1Transaction(0.0);
		m_atc.SetPurse2Transaction(0.0);
		m_atc.SetPointsTransaction(nPoints);
		m_atc.SetSourceType(AUDIT_SERVER);

		int nAppNo = (m_nTransactionAppNo == APPNO_REFUNDSALE) ? nAppNoRefund : nAppNoSale;

		m_atc.SetApplicationNo(nAppNo);					// audit bonus points
		SaveAuditCustomer(RowAccount, Server.GetRewardComment());

		m_nPointsAwarded += nPoints;
	}
}

//*******************************************************************

void CEposLoyaltyFile::ProcessPurchaseHistory(CSQLRowAccountFull& RowAccount)
{
	if (Server.GetPurchaseHistoryFlag() == TRUE)		// see if purchase history required
	{
		if (m_TLogRecordPurchase.GetItemCounter() > 0)				// see if have anything
		{
			m_TLogRecordPurchase.SetDbNo(m_FolderSetIndex.m_nDbNo);
			m_TLogRecordPurchase.SetFolderSet(m_FolderSetIndex.m_nSetNo);
			m_TLogRecordPurchase.SetTerminalNo(m_nTillNo);
			m_TLogRecordPurchase.SetDate(m_dateTransaction.GetDate());
			m_TLogRecordPurchase.SetTime(m_timeTransaction.GetTime());
			m_TLogRecordPurchase.SetCCNo(m_nTransactionCCNo);		// CCNo used wen epos sale saved in auditi file
			m_TLogRecordPurchase.AddToPurse1Spend(m_dPurse1Spend);
			m_TLogRecordPurchase.AddToPurse2Spend(m_dPurse2Spend);
			m_TLogRecordPurchase.SetPurse1(RowAccount.GetPurse1Balance());
			m_TLogRecordPurchase.SetPurse2(RowAccount.GetPurse2Balance());

			// check account is collecting plu points
			if (FALSE == m_bGroupDisablePluBonus)
			{
				m_TLogRecordPurchase.ApplyBonusPointsMultiplier(m_nBonusMultiplier);
			}

			CSSFile file;
			if (file.Open(Filenames.GetPurchaseHistoryUpdateFilename(m_strCustomerCardNo), "ab") == TRUE)
			{
				m_TLogRecordPurchase.WriteLine(&file);
				file.Close();
			}
		}
	}
}

//*******************************************************************

void CEposLoyaltyFile::AutoRedeemPoints(CSQLRowAccountFull& RowAccount, CRedeemPoints* pPointsRedeemer)
{
	double dValueAdded = 0.0;
	int nPointsRedeemed = pPointsRedeemer->Redeem(RowAccount.GetPoints(), dValueAdded);

	if (nPointsRedeemed > 0)
	{
		bool bRedeemToPurse2 = TRUE;
		bRedeemToPurse2 &= System.GetEnablePurse2Flag();
		bRedeemToPurse2 &= Server.GetSpendBonusToPurse2Flag();

		if (FALSE == bRedeemToPurse2)
		{
			RowAccount.AddToPurse1(dValueAdded);
			m_atc.SetPurse1Transaction(dValueAdded);
			m_atc.SetPurse2Transaction(0.0);
		}
		else
		{
			RowAccount.AddToPurse2(dValueAdded);
			m_atc.SetPurse1Transaction(0.0);
			m_atc.SetPurse2Transaction(dValueAdded);
		}

		RowAccount.AddToPoints(-nPointsRedeemed);
		m_atc.SetPointsTransaction(-nPointsRedeemed);
		m_atc.SetCashTransaction(0.0);
		m_atc.SetSourceType(AUDIT_SERVER);
		m_atc.SetApplicationNo(APPNO_REDEEM);		// points redemption
		SaveAuditCustomer(RowAccount, Server.GetRedeemComment());
	}
}

//*******************************************************************

void CEposLoyaltyFile::SaveAuditCustomer( CSQLRowAccountFull& RowAccount, const char* szComment)
{
	m_atc.SetPoints(RowAccount.GetPoints());
	m_atc.SetPointsTD(RowAccount.GetPointsToDate());
	m_atc.SetPurse1(RowAccount.GetPurse1Balance());
	m_atc.SetPurse2(RowAccount.GetPurse2Balance());
	m_atc.SetPurse1SpendTD(RowAccount.GetPurse1SpendToDate());
	m_atc.SetPurse2SpendTD(RowAccount.GetPurse2SpendToDate());
	m_atc.SetCashSpendTD(RowAccount.GetCashSpendToDate());
	SaveAuditInternal(szComment);
}

//*******************************************************************

void CEposLoyaltyFile::SaveAuditInternal(const char* szComment)
{
	m_atc.SetComment(szComment);

	if (m_atc.SaveLineToArray(m_arrayPendingAudit) == TRUE)
	{
		if ((TRUE == m_bExternalMode) && (0 == m_nExternalCCNo))
		{
			m_nExternalCCNo = m_atc.GetCCNo();
		}
	}
}

//******************************************************************

int CEposLoyaltyFile::GetBonusMultiplier()
{
	int nFactor = 1;
	CSSTime timeStart;
	CSSTime timeEnd;

	if (m_timeTransaction.IsSet() == TRUE)		// get day of transaction
	{
		switch (m_dateTransaction.GetDayOfWeek())	// 1=sunday 2=monday..7=saturday, 0-not set
		{
		case 0:
			break;

		case 1:
			timeStart = Server.GetRewardSunStart();
			timeEnd = Server.GetRewardSunEnd();
			nFactor = Server.GetRewardMultiplierSun();
			break;

		case 2:
			timeStart = Server.GetRewardMonStart();
			timeEnd = Server.GetRewardMonEnd();
			nFactor = Server.GetRewardMultiplierMon();
			break;

		case 3:
			timeStart = Server.GetRewardTueStart();
			timeEnd = Server.GetRewardTueEnd();
			nFactor = Server.GetRewardMultiplierTue();
			break;

		case 4:
			timeStart = Server.GetRewardWedStart();
			timeEnd = Server.GetRewardWedEnd();
			nFactor = Server.GetRewardMultiplierWed();
			break;

		case 5:
			timeStart = Server.GetRewardThuStart();
			timeEnd = Server.GetRewardThuEnd();
			nFactor = Server.GetRewardMultiplierThu();
			break;

		case 6:
			timeStart = Server.GetRewardFriStart();
			timeEnd = Server.GetRewardFriEnd();
			nFactor = Server.GetRewardMultiplierFri();
			break;

		case 7:
			timeStart = Server.GetRewardSatStart();
			timeEnd = Server.GetRewardSatEnd();
			nFactor = Server.GetRewardMultiplierSat();
			break;
		}
	}

	if (nFactor == 1)								// see if bonus multiplier set or date / time not set
	{
		return 1;									// not set
	}
	
	if ((m_timeTransaction >= timeStart) && (m_timeTransaction <= timeEnd))	// see if transaction time is in range 
	{
		if (m_bRewardIncludePurse1Spend || m_bRewardIncludePurse2Spend || m_bRewardIncludeCashSpend)
		{
			double dSpendValue = 0.0;

			if (m_bRewardIncludePurse1Spend == TRUE)
			{
				// Spend on card ( spend may be -ve if Refund)
				dSpendValue = m_dPurse1Spend;
			}

			if (m_bRewardIncludePurse2Spend == TRUE)
			{
				// Spend on purse2 ( spend may be -ve if Refund) - //v2.04x  14/08/2015
				dSpendValue += m_dPurse2Spend;
			}

			if (m_bRewardIncludeCashSpend == TRUE)
			{
				dSpendValue += m_dCashSpend;
			}

			//See if spend triggers multiplier, may need to refund bonus
			if (fabs(dSpendValue) >= m_dRewardMultiplierTrigger)					
			{
				return nFactor;										
			}
		}
		else
		{
			return nFactor;
		}
	}
	return 1;
}

//*******************************************************************

int CEposLoyaltyFile::CalculateRewardPoints ( double dSpend )
{
	int nPoints = 0;

	if ( dSpend != 0 )	
	{
		int nFactor = (int)( dSpend / m_dRewardTrip ); 
		nPoints = m_nRewardPoints * nFactor;
	}
	return nPoints;
}

//*******************************************************************

double CEposLoyaltyFile::CalculateRewardValue ( double dSpend )
{
	double dValue = 0.0;

	if ( dSpend != 0 )
	{
		int nFactor = (int)( dSpend / m_dRewardTrip ); 
		dValue = m_dRewardValue * (double)nFactor;
	}
	return dValue;
}

//******************************************************************

int CEposLoyaltyFile::GetMaxDayInMonth( int nMonth, bool bLeapYear )
{
	switch( nMonth )
	{
	case 2:
		return bLeapYear ? 29 : 28;
		
	case 4:
	case 6:
	case 9:
	case 11:
		return 30;
		
	case 1:
	case 3:
	case 5:
	case 7:
	case 8:
	case 10:
	case 12:
		return 31;
		
	default:
		return 1;
	}
}

//******************************************************************

void CEposLoyaltyFile::AdjustRenewDayNumber(int nYear, int& nRenewDayNumber)
{
	if (nRenewDayNumber >= 60)
	{
		COleDateTime oleLeapYearTest = COleDateTime(nYear, 2, 28, 6, 0, 0);
		oleLeapYearTest += COleDateTimeSpan(1, 0, 0, 0);

		if (oleLeapYearTest.GetMonth() != 2)
		{
			nRenewDayNumber--;
		}
	}
}

//******************************************************************

void CEposLoyaltyFile::WriteAuditBuffer()
{
	if ( m_arrayPendingAudit.GetSize() > 0)
	{
		CSSFile fileOut;
		if (fileOut.Open(Filenames.GetAuditFilename(), "ab") == TRUE)		// main audit file
		{
			CAuditRecord_base atc;
			for (int n = 0; n < m_arrayPendingAudit.GetSize(); n++)
			{
				CString str = m_arrayPendingAudit.GetAt(n);

				if (str != "")
				{
					atc.ReadFromString(str);				
					atc.SaveLineToFile(&fileOut, FALSE);		// line being saved is not new

					if ((0 == m_nTransactionCCNo) && (atc.GetSourceType() == AUDIT_POS))
					{
						m_nTransactionCCNo = atc.GetCCNo();
					}
				}
			}

			fileOut.Close();
		}

		m_arrayPendingAudit.RemoveAll();
	}
}

//******************************************************************
